<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EIN Names Viewer & Editor</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
      }
      h1 {
        text-align: center;
        margin-bottom: 10px;
      }
      .subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 20px;
      }

      .main-content {
        display: flex;
        gap: 20px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }
      .main-content.active {
        opacity: 1;
        pointer-events: auto;
      }

      .sidebar {
        width: 250px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 100px);
      }
      .ein-list {
        flex: 1;
        overflow-y: auto;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fafafa;
        max-height: 500px;
      }
      .ein-item {
        padding: 10px;
        margin: 2px;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .ein-item:hover {
        background: #f0f0f0;
        border-color: #2563eb;
      }
      .ein-item.active {
        background: #2563eb;
        color: white;
        border-color: #1d4ed8;
        font-weight: 600;
      }
      .ein-item.active:hover {
        background: #1d4ed8;
      }
      .ein-item .status-badge {
        margin-left: auto;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 600;
      }
      .ein-item .status-badge.done {
        background: #059669;
        color: white;
      }
      .ein-item .status-badge.partially-done {
        background: #f59e0b;
        color: white;
      }
      .ein-item.active .status-badge {
        background: rgba(255,255,255,0.3);
        color: white;
      }
      .nav-buttons {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      .content-area {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .metric-card {
        background: #f0f0f0;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }
      .metric-label {
        font-size: 12px;
        color: #666;
      }
      .metric-value {
        font-size: 20px;
        font-weight: bold;
      }
      .metrics {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }
      .names-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        background: #fafafa;
      }
      .name-item {
        padding: 6px;
        margin: 4px 0;
        background: white;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .name-item input[type="checkbox"] {
        cursor: pointer;
      }
      .name-item label {
        cursor: pointer;
        flex: 1;
        margin: 0;
      }
      .name-item.has-mapping {
        background: #d1fae5;
        border-left: 3px solid #059669;
      }
      .name-item .mapping-badge {
        font-size: 11px;
        background: #059669;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: auto;
      }
      .selection-controls {
        margin: 10px 0;
        display: flex;
        gap: 10px;
      }
      .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      .btn {
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-weight: 500;
      }
      .btn-primary {
        background: #2563eb;
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background: #1d4ed8;
      }
      .btn-primary:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .btn-secondary:hover:not(:disabled) {
        background: #d1d5db;
      }
      .btn-secondary:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .btn-success {
        background: #059669;
        color: white;
      }
      .btn-success:hover:not(:disabled) {
        background: #047857;
      }
      .input-group {
        margin: 15px 0;
      }
      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .input-group input {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      .ein-assignment-section {
        margin: 20px 0;
        padding: 15px;
        background: #f0fdf4;
        border: 2px solid #059669;
        border-radius: 8px;
      }
      .ein-assignment-section h3 {
        margin-top: 0;
        color: #047857;
      }
      .ein-assignment-controls {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }
      .ein-assignment-controls .input-group {
        flex: 1;
        margin: 0;
      }
      .mode-toggle {
        margin: 10px 0;
        padding: 10px;
        background: #fef3c7;
        border-radius: 6px;
        border: 2px solid #f59e0b;
      }
      .mode-toggle strong {
        color: #b45309;
      }
      .completion-status-bar {
        margin: 15px 0;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
      }
      .completion-status-bar.done {
        background: #d1fae5;
        border: 2px solid #059669;
        color: #065f46;
      }
      .completion-status-bar.partially-done {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        color: #b45309;
      }
      .completion-status-bar.not-started {
        background: #fee2e2;
        border: 2px solid #dc2626;
        color: #991b1b;
      }
      .completion-status-bar .icon {
        font-size: 24px;
      }
      .loading-status {
        font-size: 12px;
        color: #666;
        text-align: center;
        padding: 8px;
        border-radius: 4px;
        min-height: 20px;
        transition: all 0.3s ease;
      }
      .loading-status.loading {
        background: #e0f2fe;
        color: #0369a1;
        font-weight: 500;
      }
      .loading-status.error {
        background: #fee2e2;
        color: #dc2626;
        font-weight: 500;
      }
      .loading-status.success {
        background: #d1fae5;
        color: #059669;
        font-weight: 500;
      }
      .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #0369a1;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        margin-right: 6px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-status:empty {
        display: none;
      }
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 300px;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
      }
      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }
      .toast.success {
        border-left: 4px solid #059669;
      }
      .toast.error {
        border-left: 4px solid #dc2626;
      }
      .toast.info {
        border-left: 4px solid #2563eb;
      }
      .toast-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .toast.success .toast-icon {
        color: #059669;
      }
      .toast.error .toast-icon {
        color: #dc2626;
      }
      .toast.info .toast-icon {
        color: #2563eb;
      }
      .toast-content {
        flex: 1;
      }
      .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 14px;
      }
      .toast-message {
        font-size: 13px;
        color: #666;
      }
      .toast-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .toast-close:hover {
        color: #333;
      }
      #einSearchResults {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        width: 250px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 9999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 4px;
      }
      .ein-result-item {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #f2f2f2;
      }
      .ein-result-item:hover {
        background: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>EIN Names Viewer & Editor</h1>
      <p class="subtitle">Manage and edit company names for EIN records</p>
      
      <!-- Progress Stats Bar -->
      <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 20px; justify-content: center; align-items: center;">
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total EINs</div>
          <div style="font-size: 24px; font-weight: bold; color: #2563eb;" id="totalEinsCount">0</div>
        </div>
        <div style="font-size: 24px; color: #ddd;">|</div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #666; margin-bottom: 4px;">‚úì Done</div>
          <div style="font-size: 24px; font-weight: bold; color: #059669;" id="doneCount">0</div>
        </div>
        <div style="font-size: 24px; color: #ddd;">|</div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #666; margin-bottom: 4px;">‚ö° Partially Done</div>
          <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="partiallyDoneCount">0</div>
        </div>
        <div style="font-size: 24px; color: #ddd;">|</div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #666; margin-bottom: 4px;">‚è≥ Not Started</div>
          <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="notStartedCount">0</div>
        </div>
      </div>

      <div class="main-content" id="mainContent">
        <div class="sidebar">
          <h2>Select EIN</h2>
          <div id="loadingStatus" class="loading-status"></div>
          <div class="ein-list" id="einList"></div>
          <div class="nav-buttons">
            <button class="btn btn-secondary" id="prevPageBtn" style="flex: 1">
              ‚Üê Previous Page
            </button>
            <button class="btn btn-secondary" id="nextPageBtn" style="flex: 1">
              Next Page ‚Üí
            </button>
          </div>
          <div
            id="pageInfo"
            style="
              margin-top: 10px;
              font-size: 12px;
              color: #666;
              text-align: center;
            "
          ></div>
        </div>

        <div class="content-area">
          <h2>Names for EIN: <span id="currentEIN"></span></h2>

          <!-- Completion Status Bar -->
          <div id="completionStatusBar" class="completion-status-bar" style="display: none;">
            <div class="icon">‚è≥</div>
            <div>
              <div style="font-size: 14px;">Status: <span id="statusText">Not Started</span></div>
              <div style="font-size: 12px; font-weight: normal; margin-top: 2px;" id="statusDescription"></div>
            </div>
          </div>

          <div class="metrics">
            <div class="metric-card">
              <div class="metric-label">Total Names</div>
              <div class="metric-value" id="totalNames">0</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Selected</div>
              <div class="metric-value" id="selectedCount">0</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Mapped Names</div>
              <div class="metric-value" id="mappedCount">0</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">New Name Set</div>
              <div class="metric-value" id="newNameStatus">No</div>
            </div>
          </div>

          <h3 style="margin-bottom: 15px">
            All Names (check to mark for review):
          </h3>

          <div class="selection-controls">
            <button class="btn btn-secondary" id="selectAllBtn">
              Mark All
            </button>
            <button class="btn btn-secondary" id="deselectAllBtn">
              Unmark All
            </button>
          </div>

          <div class="names-list" id="namesList"></div>

          <div class="input-group">
            <label for="companyNameInput">Enter Official Company Name:</label>
            <div style="display: flex; gap: 10px;">
              <input
                type="text"
                id="companyNameInput"
                placeholder="Enter the official company name"
                style="flex: 1;"
              />
              <button 
                class="btn btn-secondary" 
                id="suggestNameBtn"
                style="white-space: nowrap; min-width: 160px;"
              >
                ‚ú® Suggest Name (AI)
              </button>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-primary" id="saveBtn">
              üíæ Save Changes
            </button>
          </div>

          <!-- EIN Assignment Section -->
          <div class="ein-assignment-section">
            <h3>üîó Assign EIN to Selected Names</h3>
            <p style="margin: 5px 0; font-size: 14px; color: #047857;">
              If EIN exists: names will be <strong>transferred</strong> | If not: mapping will be <strong>stored</strong>
            </p>
            <!-- EIN Search Bar -->
            <div class="input-group" style="margin-bottom: 10px;">
              <label for="einSearchInput"><strong>Search EIN:</strong></label>
              <input type="text" id="einSearchInput" placeholder="Type EIN..." autocomplete="off" />
              <div id="einSearchResults"></div>
            </div>
            <div class="ein-assignment-controls">
              <div class="input-group">
                <label for="assignEinInput">Target EIN:</label>
                <input
                  type="text"
                  id="assignEinInput"
                  placeholder="e.g., 123456789"
                />
              </div>
              <button class="btn btn-success" id="assignEinBtn">
                üîó Assign EIN to Selected
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer"></div>

    <script>
      const API_URL = window.API_URL || (window.location.origin.includes('localhost') 
        ? 'http://localhost:8000' 
        : window.location.origin);
      const PAGE_SIZE = 20;
      let currentEINData = null;
      let allEINs = [];
      let currentIndex = 0;
      let currentPage = 1;
      let totalPages = 1;
      let isLoading = false;

      const mainContent = document.getElementById("mainContent");
      const einList = document.getElementById("einList");
      const namesList = document.getElementById("namesList");
      const companyNameInput = document.getElementById("companyNameInput");
      const assignEinInput = document.getElementById("assignEinInput");
      const prevPageBtn = document.getElementById("prevPageBtn");
      const nextPageBtn = document.getElementById("nextPageBtn");
      const loadingStatus = document.getElementById("loadingStatus");
      const pageInfo = document.getElementById("pageInfo");
      const toastContainer = document.getElementById("toastContainer");
      const completionStatusBar = document.getElementById("completionStatusBar");

      function showToast(message, type = "success", duration = 3000) {
        const existingToasts = toastContainer.querySelectorAll(".toast");
        existingToasts.forEach((toast) => toast.remove());

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = { success: "‚úì", error: "‚úï", info: "‚Ñπ" };
        const titles = { success: "Success", error: "Error", info: "Info" };

        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-title">${titles[type] || titles.info}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 10);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.parentElement && toast.remove(), 300);
        }, duration);
      }

      function updateCompletionStatusBar(status) {
        if (!status) {
          completionStatusBar.style.display = "none";
          return;
        }

        completionStatusBar.style.display = "flex";
        completionStatusBar.className = `completion-status-bar ${status}`;

        const statusConfig = {
          done: {
            icon: "‚úì",
            text: "Complete",
            description: "All names are marked or assigned"
          },
          partially_done: {
            icon: "‚ö°",
            text: "Partially Done",
            description: "Some names still need attention"
          },
          not_started: {
            icon: "‚è≥",
            text: "Not Started",
            description: "No names have been processed yet"
          }
        };

        const config = statusConfig[status] || statusConfig.not_started;
        completionStatusBar.querySelector(".icon").textContent = config.icon;
        document.getElementById("statusText").textContent = config.text;
        document.getElementById("statusDescription").textContent = config.description;
      }

      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const statsResp = await fetch(`${API_URL}/stats`);
          if (!statsResp.ok) throw new Error("Failed to fetch stats");

          const stats = await statsResp.json();

          updateTopStats(stats);

          if (!stats.has_saved_data) {
            showToast(
              "No working_data.csv found. The server will auto-load from files/unique_ein_spons.csv.",
              "info",
              5000
            );
          }

          await loadEINs();
          mainContent.classList.add("active");
        } catch (error) {
          showToast(`Error: ${error.message}`, "error", 5000);
        }
      });

      function updateTopStats(stats) {
        document.getElementById("totalEinsCount").textContent = stats.total_eins || 0;
        document.getElementById("doneCount").textContent = stats.done_count || 0;
        document.getElementById("partiallyDoneCount").textContent = stats.partially_done_count || 0;
        document.getElementById("notStartedCount").textContent = stats.not_started_count || 0;
      }

      async function refreshStats() {
        try {
          const statsResp = await fetch(`${API_URL}/stats`);
          if (statsResp.ok) {
            const stats = await statsResp.json();
            updateTopStats(stats);
          }
        } catch (error) {
          console.error("Error refreshing stats:", error);
        }
      }

      function setLoadingStatus(message, type = "loading") {
        loadingStatus.className = `loading-status ${type}`;
        if (type === "loading") {
          loadingStatus.innerHTML = `<span class="spinner"></span>${message}`;
        } else {
          loadingStatus.textContent = message;
        }
      }

      function clearLoadingStatus() {
        loadingStatus.textContent = "";
        loadingStatus.className = "loading-status";
      }

      async function loadEINs(page = 1) {
        if (isLoading) return;
        if (page < 1) return;

        isLoading = true;
        setLoadingStatus(`Loading page ${page}...`, "loading");
        updatePageButtons();

        try {
          const resp = await fetch(
            `${API_URL}/eins?page=${page}&page_size=${PAGE_SIZE}`
          );
          if (!resp.ok) throw new Error("Failed to fetch EINs");

          const data = await resp.json();
          const newEINs = data.items;
          const pagination = data.pagination;

          allEINs = newEINs;
          einList.innerHTML = "";
          currentIndex = 0;

          const fragment = document.createDocumentFragment();

          newEINs.forEach((e, idx) => {
            const item = document.createElement("div");
            item.className = "ein-item";
            item.dataset.ein = e.ein;
            item.dataset.index = idx;
            
            const einText = document.createElement("span");
            einText.textContent = e.ein;
            item.appendChild(einText);

            if (e.completion_status === "done" || e.completion_status === "partially_done") {
              const badge = document.createElement("span");
              badge.className = `status-badge ${e.completion_status}`;
              badge.textContent = e.completion_status === "done" ? "‚úì" : "‚ö°";
              item.appendChild(badge);
            }

            item.addEventListener("click", () => selectEIN(idx));
            fragment.appendChild(item);
          });

          einList.appendChild(fragment);

          currentPage = pagination.page;
          totalPages = pagination.total_pages;

          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          updatePageButtons();
          clearLoadingStatus();

          if (allEINs.length > 0) {
            currentIndex = 0;
            await selectEIN(0);
          }
        } catch (error) {
          setLoadingStatus(`Error: ${error.message}`, "error");
          console.error("Error loading EINs:", error);
          setTimeout(() => clearLoadingStatus(), 5000);
        } finally {
          isLoading = false;
          updatePageButtons();
        }
      }

      function updatePageButtons() {
        prevPageBtn.disabled = currentPage <= 1 || isLoading;
        nextPageBtn.disabled = currentPage >= totalPages || isLoading;
        prevPageBtn.style.opacity = prevPageBtn.disabled ? "0.5" : "1";
        nextPageBtn.style.opacity = nextPageBtn.disabled ? "0.5" : "1";
      }

      prevPageBtn.addEventListener("click", async () => {
        if (currentPage > 1 && !isLoading) {
          await loadEINs(currentPage - 1);
        }
      });

      nextPageBtn.addEventListener("click", async () => {
        if (currentPage < totalPages && !isLoading) {
          await loadEINs(currentPage + 1);
        }
      });

      async function selectEIN(index) {
        if (index >= 0 && index < allEINs.length) {
          currentIndex = index;
          updateActiveEIN();
          await loadEINData();
        }
      }

      function updateActiveEIN() {
        const items = einList.querySelectorAll(".ein-item");
        items.forEach((item, idx) => {
          const itemIndex = parseInt(item.dataset.index);
          if (itemIndex === currentIndex) {
            item.classList.add("active");
            item.scrollIntoView({ behavior: "smooth", block: "nearest" });
          } else {
            item.classList.remove("active");
          }
        });
      }

      async function loadEINData() {
        if (allEINs.length === 0 || currentIndex >= allEINs.length) return;

        const ein = allEINs[currentIndex].ein;
        setLoadingStatus(`Loading EIN ${ein}...`, "loading");

        try {
          const resp = await fetch(`${API_URL}/ein/${ein}`);
          if (!resp.ok) throw new Error("Failed to fetch EIN data");

          currentEINData = await resp.json();

          document.getElementById("currentEIN").textContent = ein;
          document.getElementById("totalNames").textContent =
            currentEINData.total_names;

          updateCompletionStatusBar(currentEINData.completion_status);
          

          const fragment = document.createDocumentFragment();
          const markedSet = new Set(currentEINData.marked_names || []);
          const mappings = currentEINData.name_ein_mappings || {};

          currentEINData.unique_names_v2.forEach((name, idx) => {
            const div = document.createElement("div");
            div.className = "name-item";
            
            if (mappings[name]) {
              div.classList.add("has-mapping");
            }

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = name;
            checkbox.id = `name_${idx}`;
            checkbox.checked = markedSet.has(name);

            const label = document.createElement("label");
            label.htmlFor = `name_${idx}`;
            label.textContent = name;

            div.appendChild(checkbox);
            div.appendChild(label);

            if (mappings[name]) {
              const badge = document.createElement("span");
              badge.className = "mapping-badge";
              badge.textContent = `‚Üí ${mappings[name]}`;
              div.appendChild(badge);
            }

            fragment.appendChild(div);
          });

          namesList.innerHTML = "";
          namesList.appendChild(fragment);

          companyNameInput.value = currentEINData.new_name ?? "";
          document.getElementById("newNameStatus").textContent =
            currentEINData.new_name ? "Yes" : "No";
          
          // Update mapped count
          document.getElementById("mappedCount").textContent = 
            Object.keys(mappings).length;

          updateSelectedCount();
          clearLoadingStatus();
        } catch (error) {
          setLoadingStatus(`Error loading EIN: ${error.message}`, "error");
          console.error("Error loading EIN data:", error);
          setTimeout(() => clearLoadingStatus(), 3000);
        }
      }

      let countUpdateTimeout;
      function updateSelectedCount() {
        clearTimeout(countUpdateTimeout);
        countUpdateTimeout = setTimeout(() => {
          const checked = namesList.querySelectorAll(
            'input[type="checkbox"]:checked'
          ).length;
          document.getElementById("selectedCount").textContent = checked;
        }, 50);
      }

      namesList.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          updateSelectedCount();
        }
      });

      document.getElementById("selectAllBtn").addEventListener("click", () => {
        const boxes = namesList.querySelectorAll('input[type="checkbox"]');
        boxes.forEach((b) => (b.checked = true));
        updateSelectedCount();
      });

      document.getElementById("deselectAllBtn").addEventListener("click", () => {
        const boxes = namesList.querySelectorAll('input[type="checkbox"]');
        boxes.forEach((b) => (b.checked = false));
        updateSelectedCount();
      });

      // NEW: Assign EIN to selected names
      document.getElementById("assignEinBtn").addEventListener("click", async () => {
        const targetEin = parseInt(assignEinInput.value.trim());
        
        if (!targetEin || isNaN(targetEin)) {
          showToast("Please enter a valid EIN number", "error", 3000);
          return;
        }

        const selectedCheckboxes = namesList.querySelectorAll('input[type="checkbox"]:checked');
        
        if (selectedCheckboxes.length === 0) {
          showToast("Please select at least one name to assign", "error", 3000);
          return;
        }

        const selectedNames = Array.from(selectedCheckboxes).map(cb => cb.value);
       

        // Create name-to-EIN mappings
        const mappings = {};
        selectedNames.forEach(name => {
          mappings[name] = targetEin;
        });

        // Save mappings
        const ein = allEINs[currentIndex].ein;
        const payload = {
          spons_dfe_ein: ein,
          marked_names: currentEINData.marked_names || [],
          new_name: companyNameInput.value.trim() || null,
          name_ein_mappings: mappings
        };

        const assignBtn = document.getElementById("assignEinBtn");
        assignBtn.disabled = true;
        const originalText = assignBtn.textContent;
        assignBtn.textContent = "üîó Assigning...";

        try {
          const resp = await fetch(`${API_URL}/ein/${ein}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!resp.ok) {
            const errorData = await resp.json().catch(() => ({}));
            throw new Error(errorData.detail || "Failed to save mappings");
          }

          const result = await resp.json();
          
          showToast(
            `Successfully assigned ${selectedNames.length} name(s) to EIN ${targetEin}`, 
            "success", 
            3000
          );
          
          // Clear the input
          assignEinInput.value = "";
           // Clear EIN search field + hide dropdown after assigning
          einSearchInput.value = "";
          einSearchResults.style.display = "none";
          
          // Reload data to show updated mappings
          await loadEINData();
          
        } catch (error) {
          showToast(`Error: ${error.message}`, "error", 4000);
          console.error("Error assigning EIN:", error);
        } finally {
          assignBtn.disabled = false;
          assignBtn.textContent = originalText;
        }
      });

      // NEW: Suggest name using AI
      document.getElementById("suggestNameBtn").addEventListener("click", async () => {
        const suggestBtn = document.getElementById("suggestNameBtn");
        
        // Get marked/selected names
        const selectedCheckboxes = namesList.querySelectorAll('input[type="checkbox"]:checked');
        
        if (selectedCheckboxes.length === 0) {
          showToast("Please select at least one name to generate a suggestion", "error", 3000);
          return;
        }

        const selectedNames = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        // Disable button and show loading state
        suggestBtn.disabled = true;
        const originalText = suggestBtn.textContent;
        suggestBtn.textContent = "‚ú® Suggesting...";
        setLoadingStatus("AI is analyzing names...", "loading");

        try {
          const resp = await fetch(`${API_URL}/suggest-name`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ names: selectedNames })
          });

          if (!resp.ok) {
            const errorData = await resp.json().catch(() => ({}));
            throw new Error(errorData.detail || "Failed to get AI suggestion");
          }

          const result = await resp.json();
          
          // Set the suggested name in the input field
          companyNameInput.value = result.suggested_name;
          
          showToast(
            `AI suggested name based on ${result.input_count} variation(s)`, 
            "success", 
            3000
          );
          clearLoadingStatus();
          
        } catch (error) {
          showToast(`Error: ${error.message}`, "error", 4000);
          console.error("Error getting AI suggestion:", error);
          clearLoadingStatus();
        } finally {
          suggestBtn.disabled = false;
          suggestBtn.textContent = originalText;
        }
      });
      let allEinsList = [];

  // 1. Load all EINs on page startup
  async function loadAllEinsForSearch() {
    try {
      let page = 1;
      let finished = false;

      while (!finished) {
        const res = await fetch(`${API_BASE}/eins?page=${page}&page_size=5000`);
        const data = await res.json();
        
        if (data.items?.length > 0) {
          allEinsList.push(...data.items.map(i => i.ein));
        }

        if (!data.pagination?.has_next) {
          finished = true;
        } else {
          page++;
        }
      }

      console.log("Loaded EINs:", allEinsList.length);

    } catch (err) {
      console.error("Failed to load EINs for search", err);
    }
  }

  // === EIN Search: robust implementation ===
// let allEinsList = []; // strings
        let einSearchLoaded = false;

        async function loadAllEinsForSearch() {
          // Loads EINs from /eins pagination. Uses API_URL from your script.
          try {
            let page = 1;
            const pageSize = 1000; // large enough to minimize pages
            allEinsList = [];

            while (true) {
              const url = `${API_URL}/eins?page=${page}&page_size=${pageSize}`;
              const res = await fetch(url);
              if (!res.ok) {
                console.warn("EIN search: failed to fetch page", page, res.status);
                break;
              }
              const data = await res.json();
              if (data.items && data.items.length) {
                // push as strings for reliable matching
                allEinsList.push(...data.items.map(i => String(i.ein)));
              }

              // stop if no more pages
              if (!data.pagination || !data.pagination.has_next) {
                break;
              }
              page += 1;
            }

            // remove duplicates and sort (optional)
            allEinsList = Array.from(new Set(allEinsList)).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));

            einSearchLoaded = true;
            console.info("EIN search loaded:", allEinsList.length, "EINs");
          } catch (err) {
            console.error("EIN search load error:", err);
            einSearchLoaded = false;
          }
        }

        const einSearchInput = document.getElementById("einSearchInput");
        const einSearchResults = document.getElementById("einSearchResults");
        const assignEinInputEl = document.getElementById("assignEinInput");

        // helper to get fallback list (current page)
        function getFallbackEins() {
          // `allEINs` is the paginated array you already populate elsewhere in the app
          if (Array.isArray(allEINs) && allEINs.length > 0) {
            return allEINs.map(i => String(i.ein));
          }
          return [];
        }

        // render matches into the dropdown
        function renderEinMatches(matches) {
          if (!matches || matches.length === 0) {
            einSearchResults.style.display = "none";
            einSearchResults.innerHTML = "";
            return;
          }

          einSearchResults.innerHTML = matches
            .map(ein => `<div class="ein-result-item" data-ein="${ein}" style="padding:8px;cursor:pointer;border-bottom:1px solid #f2f2f2;">${ein}</div>`)
            .join("");
          einSearchResults.style.display = "block";
        }

        // search handler
        einSearchInput.addEventListener("input", (ev) => {
          const raw = einSearchInput.value.trim();
          if (!raw) {
            renderEinMatches([]);
            return;
          }

          const query = raw; // we'll search as substring (you can also do startsWith)

          // choose source: prefer full list, fallback to current page
          const source = (einSearchLoaded && allEinsList.length > 0) ? allEinsList : getFallbackEins();

          // If still empty, try to trigger loader (non-blocking)
          if (source.length === 0 && !einSearchLoaded) {
            // attempt background load (no await)
            loadAllEinsForSearch();
          }

          // Accept query length >= 1 (change if you want >=2)
          if (query.length < 1) {
            renderEinMatches([]);
            return;
          }

          // filter (case-insensitive not needed for digits, but keep consistent)
          const matches = source
            .filter(ein => ein.includes(query))
            .slice(0, 30); // limit results for UI

          renderEinMatches(matches);
        });

        // click to select EIN
        einSearchResults.addEventListener("click", (e) => {
          const item = e.target.closest(".ein-result-item");
          if (!item) return;
          const selectedEin = item.getAttribute("data-ein");
          if (selectedEin) {
            assignEinInputEl.value = selectedEin;
            // also set search input to show chosen EIN and hide list
            einSearchInput.value = selectedEin;
            renderEinMatches([]);
            // optional: set focus to assign input
            assignEinInputEl.focus();
          }
        });

        // hide dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (!einSearchResults.contains(e.target) && e.target !== einSearchInput) {
            einSearchResults.style.display = "none";
          }
        });

        // initialize search load (non-blocking)
        loadAllEinsForSearch();



      document.getElementById("saveBtn").addEventListener("click", async () => {
        const saveBtn = document.getElementById("saveBtn");
        const ein = allEINs[currentIndex].ein;

        const allCheckboxes = namesList.querySelectorAll('input[type="checkbox"]');
        const markedNames = [];

        allCheckboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            markedNames.push(checkbox.value);
          }
        });

        const newName = companyNameInput.value.trim();

        if (!newName && markedNames.length === 0) {
          setLoadingStatus(
            "Please either enter a company name or mark some names for review.",
            "error"
          );
          setTimeout(() => clearLoadingStatus(), 3000);
          return;
        }

        const payload = {
          spons_dfe_ein: ein,
          marked_names: markedNames,
          new_name: newName || null,
          name_ein_mappings: currentEINData.name_ein_mappings || {}
        };

        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "üíæ Saving...";
        setLoadingStatus(`Saving changes for EIN ${ein}...`, "loading");

        try {
          const resp = await fetch(`${API_URL}/ein/${ein}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!resp.ok) {
            const errorData = await resp.json().catch(() => ({}));
            throw new Error(errorData.detail || "Failed to save changes");
          }

          const result = await resp.json();

          allEINs[currentIndex].is_edited = true;

          const einItem = einList.querySelector(`[data-ein="${ein}"]`);
          if (einItem) {
            einItem.textContent = `${ein} ‚úî`;
          }

          const successMessage = result.message || "Changes saved successfully!";
          showToast(successMessage, "success", 3000);
          clearLoadingStatus();

          // Refresh top stats after save
          // await refreshStats();

          const respData = await fetch(`${API_URL}/ein/${ein}`);
          if (respData.ok) {
            currentEINData = await respData.json();

            document.getElementById("totalNames").textContent =
              currentEINData.total_names;
            companyNameInput.value = currentEINData.new_name ?? "";
            document.getElementById("newNameStatus").textContent =
              currentEINData.new_name ? "Yes" : "No";

            const fragment = document.createDocumentFragment();
            const markedSet = new Set(currentEINData.marked_names || []);
            const mappings = currentEINData.name_ein_mappings || {};

            currentEINData.unique_names_v2.forEach((name, idx) => {
              const div = document.createElement("div");
              div.className = "name-item";
              
              if (mappings[name]) {
                div.classList.add("has-mapping");
              }

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = name;
              checkbox.id = `name_${idx}`;
              checkbox.checked = markedSet.has(name);

              const label = document.createElement("label");
              label.htmlFor = `name_${idx}`;
              label.textContent = name;

              div.appendChild(checkbox);
              div.appendChild(label);

              if (mappings[name]) {
                const badge = document.createElement("span");
                badge.className = "mapping-badge";
                badge.textContent = `‚Üí ${mappings[name]}`;
                div.appendChild(badge);
              }

              fragment.appendChild(div);
            });

            namesList.innerHTML = "";
            namesList.appendChild(fragment);
            
            document.getElementById("mappedCount").textContent = 
              Object.keys(mappings).length;
            updateSelectedCount();
          }

          setTimeout(async () => {
            if (currentIndex < allEINs.length - 1) {
              await selectEIN(currentIndex);
            } else if (currentPage < totalPages) {
              await loadEINs(currentPage);
              if (allEINs.length > 0) {
                await selectEIN(0);
              }
            }
          }, 500);
        } catch (error) {
          showToast(`Error: ${error.message}`, "error", 4000);
          console.error("Error saving changes:", error);
          // clearLoadingStatus();
          
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      });
    </script>
  </body>
</html>